<!DOCTYPE html>

<html>
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

      <script
           src="https://code.jquery.com/jquery-3.3.1.min.js"
           integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
           crossorigin="anonymous"></script>
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

      <script type="text/javascript">
        class Player extends HTMLElement {
          render() {
            const name = this.getAttribute('name') || '';
            const img = this.getAttribute('img') || '/image/empty.png';
            const title = this.getAttribute('title') || '';
            const volume = this.getAttribute('volume') || 0;

            this.innerHTML = `<div class="row">
                                <img id="cover" src="${img}" class="col s2">
                                <div class="col s10">
                                  <h3 style="margin: 0 0 0 0;"><span>Playing:</span> <span id="name">${name}</name></h3>
                                  <marquee>${title}</marquee>
                                  <div class="row">
                                    <input type="range" min="1" max="100" value="${volume}" id="volumeSlider" class="col s10" onchange="updateVolume()">
                                    <i class="material-icons col s1" style="margin: 15px 0;">volume_off</i>
                                  </div>
                                </div>
                              </div>`;
          }

          connectedCallback() {
            if (!this.rendered) {
              this.render(name );
              this.rendered = true;
            }
          }

          static get observedAttributes() {
              return ["name", "img", "title", "volume"];
          }
          attributeChangedCallback(name, oldValue, newValue) {
            console.log("render");
            this.render();
          }
        }

        class Station extends HTMLElement {
          card(name, img, btnfn) {
            return `<div class="col s3 m3">
                      <div class="card">
                        <div class="card-image">
                          <img src="${img}">
                          <a class="btn-floating halfway-fab waves-effect waves-light red" onclick="${btnfn}">
                            <i class="material-icons">play_arrow</i>
                          </a>
                        </div>
                        <div class="card-content">
                          <p><b>${name}</b></p>
                        </div>
                      </div>
                    </div>`;
          }

          render() {
            const name = this.getAttribute('name') || '';
            const img = this.getAttribute('img') || '/image/empty.png';
            const btnfn = this.getAttribute('btnfn') || '';
            this.innerHTML = this.card(name, img, btnfn);
          }

          connectedCallback() {
            if (!this.rendered) {
              this.render();
              this.rendered = true;
            }
          }
        }

         var socket = null;
         var isopen = false;

         window.onload = function() {
            try {
              customElements.define('station-item', Station);
              customElements.define('player-control', Player);
            } catch (err) {
              const h3 = document.createElement('h3')
              h3.innerHTML = "This site uses webcomponents which don't work in all browsers! Try this site in a browser that supports them!";
              document.body.appendChild(h3);
              console.log(err);
            }
            // load station list
            getRadioStationList();

            socket = new WebSocket("ws://127.0.0.1:9000");

            socket.onopen = function() {
               console.log("Connected!");
               isopen = true;
            }

            socket.onmessage = function(e) {
               if (typeof e.data == "string") {
                  console.log("Text message received: " + e.data);
                  const player = document.getElementById("player");

                  data = JSON.parse(e.data)
                  if ("volume" in data){
                    player.setAttribute('volume', data.volume);
                  }
                  if ("title" in data){
                    player.setAttribute('title', data.title);
                  }
                  if ("stream_key" in data){
                    const item = document.querySelectorAll(`[key="${data.stream_key}"]`)[0];
                    if(item){
                      player.setAttribute('name', item.getAttribute("name"));
                      player.setAttribute('img', item.getAttribute("img"));
                    }
                  }
               }
            }

            socket.onclose = function(e) {
               console.log("Connection closed.");
               socket = null;
               isopen = false;
            }
         };

         function getRadioStationList() {
          $.get("/streamurls", function(data, status){
                  json = JSON.parse(data);
                  for(index in json){
                     item = json[index];
                     html = `<station-item key="${item.url}" name="${item.name}" img="${item.img}" btnfn="play('${item.url}')" />`;
                     document.getElementById("radiolist").innerHTML += html;
                  }
            });
         }

         function play(url){
            console.log('play: ' + url);

            postData = {"url": url};
            $.ajax({
                 type: "POST",
                 url: "/play",
                 data: JSON.stringify(postData),
                 success: function() {  },
                 dataType: "json",
                 contentType : "application/json"
             });
         }

         function pause(){
            console.log('pause');
            $.ajax({
                 type: "POST",
                 url: "/stop",
                 data: '',
                 success: function() {  },
                 dataType: "json",
                 contentType : "application/json"
             });
         }

         function updateVolume(){
            const player = document.getElementById("player");
            volume = player.getElementsByTagName('input')[0].value;
            postData = {"volume": volume};
            console.log("Update Volume: " + volume);
            $.ajax({
                 type: "POST",
                 url: "/volume",
                 data: JSON.stringify(postData),
                 success: function() { },
                 dataType: "json",
                 contentType : "application/json"
             });
         }
      </script>
   </head>
   <body>
      <div class="container">
        <player-control id="player" />
      </div>
      <div class="container">
        <div id="radiolist" class="row" />
      </div>
   </body>
</html>